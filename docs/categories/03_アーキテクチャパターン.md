# アーキテクチャパターン分析

**調査日**: 2025年12月25日

---

## パターン分布

| パターン | アクティブ数 | 代表例 |
|----------|-------------|--------|
| MVVM | 15+ | Clean Architecture (6,436★) |
| Combine | 25+ | MovieSwiftUI (6,524★) |
| Clean Architecture | 3+ | iOS-Clean-Architecture-MVVM (4,299★) |
| RxSwift | 16+ | SwiftHub (3,114★) |
| VIPER | 4+ | Currency Converter (228★) |
| Redux/TCA | 5+ | isowords (2,942★) |

---

## パターン1: MVVM

### 構造

```
┌─────────────────────────────────────┐
│           VIEW層                    │
│  SwiftUI Views ←→ ViewModels       │
├─────────────────────────────────────┤
│         DOMAIN層                    │
│  Interactors ← プロトコル → Entity │
├─────────────────────────────────────┤
│          DATA層                     │
│  Repository ← プロトコル → API     │
└─────────────────────────────────────┘
```

### 実装例

```swift
class UsersViewModel: ObservableObject {
    @Published var users: [User] = []
    @Published var isLoading = false

    private let repository: UserRepository
    private var cancellables = Set<AnyCancellable>()

    func loadUsers() {
        isLoading = true
        repository.fetchUsers()
            .receive(on: DispatchQueue.main)
            .sink { [weak self] users in
                self?.users = users
                self?.isLoading = false
            }
            .store(in: &cancellables)
    }
}
```

### 採用アプリ
- Clean Architecture SwiftUI (6,436★)
- iOS-Clean-Architecture-MVVM (4,299★)
- SwiftHub (3,114★)
- SwiftUI-MVVM (785★)

---

## パターン2: Redux/TCA（単方向データフロー）

### 構造

```
┌─────────────────────────────────────┐
│         ユーザー操作                 │
│              ↓                      │
│           ACTION                    │
│              ↓                      │
│  ┌─────────────────────────────┐   │
│  │          STORE              │   │
│  │ State + Reducer → Effects  │   │
│  └─────────────────────────────┘   │
│              ↓                      │
│           STATE                     │
│              ↓                      │
│           VIEW                      │
└─────────────────────────────────────┘
```

### TCA実装例

```swift
struct AppState: Equatable {
    var counter: Int = 0
    var todos: [Todo] = []
}

enum AppAction {
    case increment
    case addTodo(String)
}

let appReducer = Reducer<AppState, AppAction, AppEnvironment> {
    state, action, environment in
    switch action {
    case .increment:
        state.counter += 1
        return .none
    case .addTodo(let title):
        state.todos.append(Todo(title: title))
        return .none
    }
}
```

### 採用アプリ
- isowords (2,942★) - TCA
- MovieSwiftUI (6,524★) - Redux風
- FireTodo (377★) - Redux

---

## パターン3: RxSwift

### Input/Outputパターン

```swift
class RepositoryViewModel: ViewModelType {
    struct Input {
        let trigger: Observable<Void>
        let selection: Observable<IndexPath>
    }

    struct Output {
        let items: Driver<[CellViewModel]>
        let selected: Driver<Repository>
    }

    func transform(input: Input) -> Output {
        let items = input.trigger
            .flatMapLatest { self.useCase.fetch() }
            .map { $0.map { CellViewModel($0) } }
            .asDriver(onErrorJustReturn: [])
        // ...
    }
}
```

### 採用アプリ
- SwiftHub (3,114★)
- RxTodo (1,298★)
- SpotifyRadar (647★)

---

## パターン4: VIPER

### 構造

```
View ←→ Presenter ←→ Interactor
  ↑         │            │
  └──── Router       Entity
```

### 役割
- **View**: UI表示とユーザー入力
- **Interactor**: ビジネスロジック
- **Presenter**: データフォーマット
- **Entity**: データモデル
- **Router**: 画面遷移

### 採用アプリ
- Currency Converter (228★)
- live-news-viper (156★)

---

## データ層パターン

### Core Data

```swift
// SwiftUIとの統合
@FetchRequest(
    sortDescriptors: [NSSortDescriptor(keyPath: \Item.timestamp, ascending: true)]
)
private var items: FetchedResults<Item>
```

**採用例**: Velik (344★), Reading List (303★)

### Realm

```swift
@ObservedResults(Dog.self) var dogs

try realm.write {
    realm.add(newDog)
}
```

**採用例**: Find (1,045★), RaceMe (616★)

### Firebase

```swift
Firestore.firestore()
    .collection("users")
    .snapshotPublisher()
    .map { $0.documents.compactMap { try? $0.data(as: User.self) } }
```

**採用例**: Messenger (4,800★), MakeItSo (523★)

---

## ネットワーク層

### async/await

```swift
protocol APIClient {
    func request<T: Decodable>(_ endpoint: Endpoint) async throws -> T
}

class URLSessionAPIClient: APIClient {
    func request<T: Decodable>(_ endpoint: Endpoint) async throws -> T {
        let (data, _) = try await URLSession.shared.data(for: endpoint.urlRequest)
        return try JSONDecoder().decode(T.self, from: data)
    }
}
```

### Alamofire（31アプリ）

```swift
AF.request(endpoint.url, method: .get, parameters: params)
    .validate()
    .responseDecodable(of: Response.self) { response in
        // 処理
    }
```

---

## 依存性注入

### SwiftUI Environment

```swift
struct APIClientKey: EnvironmentKey {
    static let defaultValue: APIClient = LiveAPIClient()
}

extension EnvironmentValues {
    var apiClient: APIClient {
        get { self[APIClientKey.self] }
        set { self[APIClientKey.self] = newValue }
    }
}

// 使用
@Environment(\.apiClient) var apiClient
```

### DIコンテナ

```swift
class DIContainer {
    static let shared = DIContainer()
    lazy var apiClient: APIClient = URLSessionAPIClient()
    lazy var userRepository: UserRepository = UserRepositoryImpl(api: apiClient)
}
```

---

## 推奨パターン

| アプリ規模 | 推奨パターン | 理由 |
|------------|-------------|------|
| 小規模 | MVVM + Combine | シンプル、学習コスト低 |
| 中規模 | Clean Architecture + MVVM | 分離明確、テスト容易 |
| 大規模 | TCA | 予測可能、モジュラー |
| レガシー混在 | Repository + Service層 | UIKit/SwiftUI両対応 |

---

## 学習リソース

| アーキテクチャ | 最良の例 | 学習ポイント |
|---------------|----------|-------------|
| MVVM | clean-architecture-swiftui | 本番品質の実装 |
| TCA | isowords | Point-Freeの参照実装 |
| RxSwift | SwiftHub | 完全なリアクティブ設計 |
| VIPER | Currency Converter | VIPERの明確な分離 |
